# Student Course Enrollment System - Access Patterns
---
# 1. Overview

Typical data access patterns include query patterns, read/write operations, performance considerations, and best practices for database access.

---

# 2. Read Patterns

## 2.1 Get All Courses

```csharp
var courses = await dbContext.Courses
    .AsNoTracking()
    .ToListAsync();
```

Use `AsNoTracking()` for read-only queries to improve performance.

---

## 2.2 Get Course by ID

```csharp
var course = await dbContext.Courses
    .AsNoTracking()
    .FirstOrDefaultAsync(c => c.Id == courseId);
```

---

## 2.3 Get Student Enrollments

```csharp
var enrollments = await dbContext.Enrollments
    .AsNoTracking()
    .Where(e => e.StudentId == studentId)
    .Include(e => e.Course)
    .OrderBy(e => e.EnrolledAt)
    .ToListAsync();
```

Use `Include()` to load related entities efficiently.

---

## 2.4 Get Course Enrollments

```csharp
var enrollments = await dbContext.Enrollments
    .AsNoTracking()
    .Where(e => e.CourseId == courseId)
    .Include(e => e.Student)
    .ToListAsync();
```

---

## 2.5 Check Duplicate Enrollment

```csharp
var exists = await dbContext.Enrollments
    .AnyAsync(e => e.StudentId == studentId && e.CourseId == courseId);
```

Use `AnyAsync()` for existence checks.

---

## 2.6 Get Student by Email

```csharp
var student = await dbContext.Students
    .AsNoTracking()
    .FirstOrDefaultAsync(s => s.Email == email);
```

---

# 3. Write Patterns

## 3.1 Create Student

```csharp
var student = new Student
{
    Id = Guid.NewGuid(),
    Email = request.Email,
    PasswordHash = BCrypt.HashPassword(request.Password),
    FirstName = request.FirstName,
    LastName = request.LastName,
    CreatedAt = DateTime.UtcNow
};

dbContext.Students.Add(student);
await dbContext.SaveChangesAsync();
```

---

## 3.2 Create Course

```csharp
var course = new Course
{
    Id = Guid.NewGuid(),
    Name = request.Name,
    Description = request.Description,
    Capacity = request.Capacity,
    CreatedAt = DateTime.UtcNow
};

dbContext.Courses.Add(course);
await dbContext.SaveChangesAsync();
```

---

## 3.3 Create Enrollment

```csharp
var enrollment = new Enrollment
{
    Id = Guid.NewGuid(),
    StudentId = studentId,
    CourseId = courseId,
    EnrolledAt = DateTime.UtcNow
};

dbContext.Enrollments.Add(enrollment);
await dbContext.SaveChangesAsync();
```

---

## 3.4 Delete Enrollment

```csharp
var enrollment = await dbContext.Enrollments
    .FirstOrDefaultAsync(e => e.Id == enrollmentId);

if (enrollment != null)
{
    dbContext.Enrollments.Remove(enrollment);
    await dbContext.SaveChangesAsync();
}
```

---

## 3.5 Update Course

```csharp
var course = await dbContext.Courses.FindAsync(courseId);
if (course != null)
{
    course.Name = request.Name;
    course.Description = request.Description;
    await dbContext.SaveChangesAsync();
}
```

---

# 4. Query Optimization Patterns

## 4.1 Use Projection

```csharp
var courseSummaries = await dbContext.Courses
    .AsNoTracking()
    .Select(c => new CourseSummaryDto
    {
        Id = c.Id,
        Name = c.Name,
        Description = c.Description
    })
    .ToListAsync();
```

Project only needed fields to reduce data transfer.

---

## 4.2 Use Pagination

```csharp
var pageSize = 10;
var pageNumber = 1;

var courses = await dbContext.Courses
    .AsNoTracking()
    .Skip((pageNumber - 1) * pageSize)
    .Take(pageSize)
    .ToListAsync();
```

---

## 4.3 Count Before Pagination

```csharp
var totalCount = await dbContext.Courses.CountAsync();
var totalPages = (int)Math.Ceiling(totalCount / (double)pageSize);
```

---

# 5. Transaction Patterns

## 5.1 Simple Transaction

```csharp
using var transaction = await dbContext.Database.BeginTransactionAsync();
try
{
    // Multiple operations
    await dbContext.SaveChangesAsync();
    await transaction.CommitAsync();
}
catch
{
    await transaction.RollbackAsync();
    throw;
}
```

---

# 6. Performance Best Practices

## 6.1 Use AsNoTracking

Always use `AsNoTracking()` for read-only queries:

```csharp
var courses = await dbContext.Courses
    .AsNoTracking()
    .ToListAsync();
```

## 6.2 Avoid N+1 Queries

Use `Include()` to load related entities:

```csharp
var enrollments = await dbContext.Enrollments
    .Include(e => e.Course)
    .Include(e => e.Student)
    .ToListAsync();
```

## 6.3 Use Appropriate Async Methods

Always use async methods:
- `ToListAsync()` instead of `ToList()`
- `FirstOrDefaultAsync()` instead of `FirstOrDefault()`
- `AnyAsync()` instead of `Any()`

---

# 7. Error Handling Patterns

## 7.1 Handle Not Found

```csharp
var course = await dbContext.Courses.FindAsync(courseId);
if (course == null)
{
    return Results.NotFound("Course not found");
}
```

## 7.2 Handle Unique Constraint Violations

```csharp
try
{
    await dbContext.SaveChangesAsync();
}
catch (DbUpdateException ex)
{
    if (ex.InnerException?.Message.Contains("UNIQUE") == true)
    {
        return Results.BadRequest("Duplicate entry");
    }
    throw;
}
```

---

# 8. Common Access Patterns

| Operation | Pattern | Example |
|-----------|---------|---------|
| Get all | AsNoTracking + ToListAsync | Get all courses |
| Get by ID | FirstOrDefaultAsync | Get course by ID |
| Get with relations | Include | Get enrollments with course |
| Check existence | AnyAsync | Check duplicate enrollment |
| Create | Add + SaveChangesAsync | Create student |
| Update | Find + modify + SaveChangesAsync | Update course |
| Delete | Remove + SaveChangesAsync | Delete enrollment |

---

