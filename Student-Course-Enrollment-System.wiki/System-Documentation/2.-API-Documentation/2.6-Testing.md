# Student Course Enrollment System – API Testing Documentation
---
# 1. Overview

API testing strategy covering Minimal API Endpoints, Business Logic, and Data Access.

API testing ensures correctness of enrollment rules, data integrity, endpoint behavior, authorization, and workflow progression.

---

# 2. Testing Layers

## 2.1 Unit Tests (Business Logic)
Unit tests validate business rules and enrollment logic without involving API endpoints, persistence, or external services.

### Unit Test Targets
- Enrollment validation rules  
- Duplicate prevention logic  
- Authentication logic  
- Authorization checks  
- Input validation  
- Business rule enforcement  

---

## 2.2 Integration Tests (Database + Endpoints)
Integration tests validate persistence and endpoint behavior using **in-memory database** or **test database**.

### Integration Test Targets
- CRUD operations  
- Database relationships  
- Entity persistence  
- Query correctness  
- Endpoint-to-database integration  
- Transaction handling  

---

## 2.3 API Functional Tests (Endpoints)
API functional tests use **WebApplicationFactory** or **TestServer** to validate endpoint behavior.

### API Functional Test Targets
- GET endpoints return correct data  
- POST endpoints validate input  
- Successful POST → correct response  
- Failed POST → error response  
- Authorization policies enforced  
- Claims-based access enforced  
- Proper DTO mapping  
- Workflow sequencing validated  

---

# 3. Required Test Scenarios

## 3.1 Authentication Scenarios (API)

### Unit Tests
- Email uniqueness validation  
- Password hashing  
- Token generation  
- Credential validation  

### Integration Tests
- Student registration persisted correctly  
- Student login retrieves correct student  
- Token generation and validation  

### API Functional Tests
- POST /auth/register with valid data → success  
- POST /auth/register with duplicate email → error  
- POST /auth/login with valid credentials → token  
- POST /auth/login with invalid credentials → error  
- Authorization enforced on protected endpoints  

---

## 3.2 Course Management Scenarios (API)

### Unit Tests
- Course validation rules  
- Course uniqueness (if applicable)  

### Integration Tests
- Course creation persisted correctly  
- Course retrieval returns correct data  
- Course updates persisted correctly  
- Course deletion handled correctly  

### API Functional Tests
- GET /courses returns course list  
- GET /courses/{id} returns course details  
- GET /courses/{id} with invalid ID → 404  
- POST /courses creates course (if admin)  
- PUT /courses/{id} updates course (if admin)  
- DELETE /courses/{id} deletes course (if admin)  

---

## 3.3 Enrollment Scenarios (API)

### Unit Tests
- Duplicate enrollment prevention  
- Enrollment validation rules  
- Student ownership validation  

### Integration Tests
- Enrollment creation persisted correctly  
- Enrollment retrieval returns correct data  
- Enrollment deletion handled correctly  
- Student-course relationship maintained  

### API Functional Tests
- POST /enrollments with valid data → success  
- POST /enrollments with duplicate → error  
- POST /enrollments without authentication → 401  
- GET /enrollments/me returns student enrollments  
- GET /enrollments/me without authentication → 401  
- DELETE /enrollments/{id} removes enrollment  
- DELETE /enrollments/{id} for other student → 403  

---

# 4. Test Data Strategy

## 4.1 Unit Tests
- Inline test data  
- No database dependencies  
- Mock dependencies  

## 4.2 Integration Tests
- Test database (in-memory or test DB)  
- Seed test data  
- Clean up after tests  

## 4.3 API Functional Tests
- Test server with test database  
- Synthetic students and courses  
- Test authentication tokens  
- No external dependencies  

---

# 5. Test Organization

## 5.1 Test Project Structure

```text
/tests
  /StudentCourseEnrollment.Tests.Unit
    /Features
      /Auth
      /Courses
      /Enrollments
  /StudentCourseEnrollment.Tests.Integration
    /Endpoints
    /Database
  /StudentCourseEnrollment.Tests.Functional
    /Endpoints
```

---

# 6. Testing Tools

## 6.1 Unit Testing
- xUnit  
- Moq (for mocking)  
- FluentAssertions  

## 6.2 Integration Testing
- xUnit  
- EF Core In-Memory Provider  
- WebApplicationFactory  

## 6.3 API Testing
- xUnit  
- WebApplicationFactory  
- HttpClient  
- FluentAssertions  

---

# 7. Test Examples

## 7.1 Unit Test Example

```csharp
[Fact]
public void Register_With_Duplicate_Email_Should_Fail()
{
    // Arrange
    var existingStudent = new Student { Email = "test@example.com" };
    var newRequest = new RegisterRequest("John", "Doe", "test@example.com", "password");
    
    // Act & Assert
    Assert.Throws<ValidationException>(() => 
        ValidateRegistration(newRequest, existingStudent));
}
```

## 7.2 Integration Test Example

```csharp
[Fact]
public async Task Create_Enrollment_Persists_Correctly()
{
    // Arrange
    var student = new Student { Id = Guid.NewGuid(), Email = "test@example.com" };
    var course = new Course { Id = Guid.NewGuid(), Name = "Test Course" };
    
    await dbContext.Students.AddAsync(student);
    await dbContext.Courses.AddAsync(course);
    await dbContext.SaveChangesAsync();
    
    // Act
    var enrollment = new Enrollment 
    { 
        StudentId = student.Id, 
        CourseId = course.Id,
        EnrolledAt = DateTime.UtcNow
    };
    dbContext.Enrollments.Add(enrollment);
    await dbContext.SaveChangesAsync();
    
    // Assert
    var saved = await dbContext.Enrollments.FindAsync(enrollment.Id);
    Assert.NotNull(saved);
    Assert.Equal(student.Id, saved.StudentId);
}
```

## 7.3 API Functional Test Example

```csharp
[Fact]
public async Task POST_Enrollments_Returns_Success()
{
    // Arrange
    var client = factory.CreateClient();
    var token = await GetAuthTokenAsync(client);
    client.DefaultRequestHeaders.Authorization = 
        new AuthenticationHeaderValue("Bearer", token);
    
    var request = new { CourseId = courseId };
    
    // Act
    var response = await client.PostAsJsonAsync("/enrollments", request);
    
    // Assert
    response.EnsureSuccessStatusCode();
    var enrollment = await response.Content.ReadFromJsonAsync<EnrollmentDto>();
    Assert.NotNull(enrollment);
}
```

---

# 8. Coverage Requirements

```
Business logic:           90%
Endpoint handlers:        90%
Data access:              85%
E2E API flows:            Scenario-based
```

All critical endpoints and workflows must be covered by tests.

---

# 9. CI/CD Integration

API tests must execute in this order:

1. Build API  
2. Unit tests  
3. Integration tests  
4. API functional tests  
5. Package and deploy  

---

# 10. Test Maintenance

## 10.1 Test Updates
- Update tests when endpoints change  
- Update tests when business rules change  
- Keep test data current  

## 10.2 Test Performance
- Tests should run quickly  
- Use in-memory database for speed  
- Parallel test execution where possible  

---

