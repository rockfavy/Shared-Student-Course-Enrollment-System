# Student Course Enrollment System – API Documentation Overview

# 1. Overview

The Student Course Enrollment System API is a **Minimal API backend** responsible for all core business logic, data workflows, and system integrations.

It powers the Course Enrollment features:

- Student Authentication  
- Course Management (CRUD)  
- Enrollment Management  

It also enforces:

- Business rules  
- Data persistence  
- Authorization rules  
- Validation  

The API integrates with:

- Blazor WASM frontend via HTTP  
- In-memory database (all environments)  
- Environment-specific authentication providers:
  - **Local**: JWT Bearer (Symmetric Key)
  - **Production**: Microsoft Entra ID
- Feature-based endpoints  

---

# 2. Project Structure

The API follows a feature-based structure following the pattern from Lesson 10.02:

```text
/Features                 → Feature-based endpoint groups
  /Auth                   → Authentication endpoints
  /Courses                → Course CRUD endpoints
  /Enrollments            → Enrollment management endpoints
/Data                     → DbContext and data configuration
/Models                   → Domain models
/Shared                   → Cross-cutting concerns
  /Authorization          → Authorization handlers and policies
  /ErrorHandling          → Global exception handling
Program.cs                → Application startup and configuration
```

### Key folders

- **Features** → Feature-based endpoint groups (Auth, Courses, Enrollments)  
- **Data** → EF Core DbContext and in-memory database configuration  
- **Models** → Domain entities (Student, Course, Enrollment)  
- **Shared** → Cross-cutting utilities (authorization, error handling)  

---

# 3. Key Flows & Responsibilities

The API implements all major enrollment operations.

## 3.1 Authentication Flows

- Student registration  
- Student login  
- Token generation  
- Authentication validation  

## 3.2 Course Flows

- List all courses  
- Get course details  
- Create course (if needed)  
- Update course (if needed)  
- Delete course (if needed)  

## 3.3 Enrollment Flows

- Enroll student in course  
- Get student enrollments  
- Deregister from course  
- Validate enrollment rules  

Each flow follows:

**Endpoint → Handler → DbContext → Response**

---

# 4. Entry Points & API Design

The API exposes REST endpoints using Minimal API pattern.

### Example Endpoint Structure

```csharp
public static class CoursesEndpoints
{
    public static void MapCourses(this IEndpointRouteBuilder app)
    {
        var group = app.MapGroup("/courses");
        
        group.MapGetCourses();
        group.MapGetCourse();
        group.MapCreateCourse();
        group.MapUpdateCourse();
        group.MapDeleteCourse();
    }
}
```

### Routing

- RESTful endpoints  
- Feature-based grouping  
- Standard HTTP verbs (GET, POST, PUT, DELETE)  

### Error Format

- Problem Details (RFC 7807)  
- Standard HTTP status codes  
- JSON responses  

---

# 5. Domain & Business Rules

The domain layer defines the core enrollment rules.

## Key Domain Entities

- **Student**  
- **Course**  
- **Enrollment**  

## Core Business Rules

- Students can enroll in multiple courses  
- Courses can have multiple students  
- Duplicate enrollment prevention  
- Enrollment validation  
- Course capacity (if applicable)  

### Enrollment State Transitions

```scss
NotEnrolled → Enrolled → Deregistered
```

**Endpoints enforce business rules before state changes.**

---

# 6. Local Development & Build

Local API development uses:

- **In-Memory Database** — for rapid development  
- **Simple Authentication** — for local testing  

### Requirements

- .NET SDK (.NET 8)  
- Visual Studio 2022 or VS Code  

### Local Workflow

1. Clone the repository  
2. Run `dotnet restore`  
3. Press F5 in Visual Studio  
4. API runs on configured port  
5. Execute flows through HTTP endpoints  

---

# 7. Security & Validation

The API enforces:

### Authentication

- **Local:** Simple token-based or identity simulation  
- **Production:** JWT/OIDC  

### Authorization

- Claims-based policies per endpoint  
- Student-specific data access  

### Validation

- Model validation  
- Business rule validation  
- Input sanitization  

### Error Handling

All errors are handled consistently via global exception handler.

---

# 8. Testing

API testing includes:

## 8.1 Automated Tests

### Unit Tests

- Endpoint handlers  
- Business rules  
- Validation logic  

### Integration Tests

- Endpoint behavior via test server  
- Database operations  

### API Functional Tests

- HTTP endpoint behavior  
- Authentication/authorization  
- Error handling  

## 8.2 Execution Methods

- Visual Studio Test Explorer  
- `dotnet test`  
- Postman/HTTP client testing  

API tests ensure:

- Endpoint correctness  
- Business rule enforcement  
- Data consistency  

---

# 9. Recent API Enhancements

## 9.1 Enrollment Capacity Enforcement

### Capacity Validation
- **Enrollment Endpoint**: The enrollment endpoint now validates course capacity before allowing enrollment
- **Atomic Operations**: Enrollment operations use database transactions to ensure capacity checks and enrollment creation are atomic
- **Concurrent Request Handling**: Race conditions are prevented through transaction-based locking
- **Error Messages**: Returns clear error message: "This course is full. Capacity: X students" when capacity is reached

### Course DTO Enhancement
- **CurrentEnrollments Field**: `CourseDto` now includes `CurrentEnrollments` property to display enrollment count
- **Real-Time Data**: Enrollment counts are calculated and included in all course retrieval endpoints

## 9.2 Course Capacity Update Validation

### Update Endpoint Enhancement
- **Capacity Validation**: Course update endpoint validates that new capacity >= current enrollment count
- **Clear Error Messages**: Returns error: "Cannot set capacity to {newCapacity}. Course currently has {currentEnrollments} enrolled students" if validation fails
- **Data Integrity**: Prevents invalid state where enrollments exceed capacity

## 9.3 Course Deletion Race Condition Handling

### Atomic Course Existence Checks
- **Transaction-Based Validation**: Course existence is re-verified within enrollment transactions
- **Clear Error Messages**: Returns error: "This course is no longer available" if course is deleted during enrollment
- **Graceful Handling**: Prevents orphaned data and provides clear feedback to users

## 9.4 Error Message Improvements

### User-Friendly Error Messages
- **Message Translation**: All API error messages are now user-friendly and actionable
- **Consistent Format**: Error messages follow consistent format across all endpoints
- **Technical Details**: Technical error details are logged server-side, not exposed to users
- **Actionable Guidance**: Error messages provide clear guidance on how to resolve issues

### Error Message Examples
- Network timeouts: "Please check your internet connection and try again"
- Validation errors: Clear, field-specific messages
- Authorization errors: "You do not have permission to perform this action"
- Capacity errors: "This course is full. Capacity: X students"

---


