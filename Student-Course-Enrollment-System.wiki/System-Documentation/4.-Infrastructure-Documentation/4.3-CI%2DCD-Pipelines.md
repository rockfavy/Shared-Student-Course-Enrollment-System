# Student Course Enrollment System – CI/CD Pipelines
---

# 1. Overview

This document describes CI/CD pipeline strategy for the Student Course Enrollment System. The system uses Azure DevOps YAML pipelines to automate building, testing, and deploying the application.

---

# 2. Pipeline Types

## 2.1 Continuous Integration (CI) Pipeline

**Purpose**: Build and test code when work moves from `userstory` to `feature` branch.

**Trigger**: Automatic on push to `feature` branch

**Stages**:
1. **Build Stage**
   - Restore NuGet packages
   - Build solution
   - Compile all projects

2. **Test Stage**
   - Run unit tests
   - Run integration tests
   - Generate test coverage reports
   - Fail pipeline if any test fails

**Pipeline File**: `devops/pipelines/ci.yml`

**Output**: Build artifacts and test results

---

## 2.2 Continuous Deployment (CD) Pipeline

**Purpose**: Build, test, and deploy to production when work moves to `main` branch.

**Trigger**: Manual trigger from `main` branch (requires approval gates)

**Stages**:
1. **Build Stage**
   - Restore NuGet packages
   - Build solution in Release configuration
   - Compile all projects

2. **Test Stage**
   - Run unit tests
   - Run integration tests
   - Generate test coverage reports
   - Fail pipeline if any test fails

3. **Deploy Stage** (Production Environment)
   - Deploy to Azure App Service staging slot
   - Run smoke tests
   - Perform slot swap (zero-downtime deployment)
   - Run post-deployment health checks
   - Automatic rollback if validation fails

**Pipeline File**: `devops/pipelines/prod-deploy.yml`

**Approval Gates**: 
- Requires manual approval before deployment
- Configured via Azure DevOps Environments

---

# 3. Pipeline Triggers

## 3.1 Branch-to-Pipeline Mapping

| Branch Type | Pipeline Type | Trigger | Purpose |
|-------------|---------------|---------|---------|
| `userstory` | ❌ None | No trigger | Development work only |
| `task` | ❌ None | No trigger | Development work only |
| `feature` | CI Pipeline | Automatic on push | Build and test validation |
| `main` | CD Pipeline | Manual trigger | Production deployment |

## 3.2 Workflow

```
userstory/task branches
    ↓ (merge via PR)
feature branch
    ↓ (triggers CI pipeline: build + test)
feature branch (validated)
    ↓ (merge via PR)
main branch
    ↓ (triggers CD pipeline: build + test + deploy)
Production Environment
```

---

# 4. CI Pipeline Details

## 4.1 Trigger Configuration

The CI pipeline automatically triggers on:
- Push to `feature` branch
- Pull request to `feature` branch (for validation)

## 4.2 Build Stage

- Restore NuGet packages
- Build entire solution
- Compile all projects (API, Frontend, Shared, Tests)
- Generate build artifacts

## 4.3 Test Stage

- Run all unit tests (`StudentCourseEnrollment.Tests.Unit`)
- Run all integration tests (`StudentCourseEnrollment.Tests.Integration`)
- Generate test coverage reports
- Publish test results
- **Pipeline fails if any test fails**

## 4.4 Artifacts

- Build artifacts (compiled binaries)
- Test results and coverage reports

---

# 5. CD Pipeline Details

## 5.1 Trigger Configuration

The CD pipeline is **manually triggered** from `main` branch:
- Requires explicit user action to start deployment
- Approval gates must be satisfied before deployment proceeds

## 5.2 Build Stage

- Restore NuGet packages
- Build solution in **Release configuration**
- Compile all projects
- Generate production-ready artifacts

## 5.3 Test Stage

- Run all unit tests
- Run all integration tests
- Generate test coverage reports
- **Pipeline fails if any test fails**
- All tests must pass before deployment proceeds

## 5.4 Deploy Stage

### Pre-Deployment
- Download build artifacts
- Configure production settings
- Validate configuration

### Deployment Steps
1. Deploy to Azure App Service **staging slot**
2. Run smoke tests on staging slot
3. Validate staging deployment health
4. **Approval gate**: Manual approval required before slot swap
5. Perform slot swap (zero-downtime deployment)
6. Run post-swap health checks
7. Notify stakeholders

### Rollback
- Automatic rollback if post-swap validation fails
- Uses previous deployment artifact

---

# 6. Approval Gates

## 6.1 Production Deployment Approvals

Production deployments require manual approval before deployment proceeds:

- **Tech Lead** (required)
- **Security Lead** (optional, if configured)

## 6.2 Approval Configuration

Approval gates are configured in Azure DevOps Environments:

1. Navigate to **Pipelines** → **Environments**
2. Create or select **Production** environment
3. Configure **Approvals and checks**:
   - Add required approvers
   - Configure timeout policies
   - Set approval expiration

## 6.3 Approval Workflow

1. Pipeline triggers from `main` branch
2. Build and test stages complete successfully
3. Deployment stage waits for approval
4. Approvers receive notification
5. After approval, deployment proceeds
6. Slot swap occurs
7. Post-deployment validation runs

---

# 7. Pipeline Configuration Files

## 7.1 CI Pipeline

**File**: `devops/pipelines/ci.yml`

**Structure**:
```yaml
trigger:
  branches:
    include:
      - feature

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'Restore packages'
          - task: DotNetCoreCLI@2
            displayName: 'Build solution'
          - task: DotNetCoreCLI@2
            displayName: 'Run tests'
```

## 7.2 CD Pipeline

**File**: `devops/pipelines/prod-deploy.yml`

**Structure**:
```yaml
trigger: none  # Manual trigger only

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'Build solution (Release)'
  
  - stage: Test
    dependsOn: Build
    jobs:
      - job: Test
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'Run tests'
  
  - stage: Deploy
    dependsOn: Test
    jobs:
      - deployment: DeployToProduction
        environment: 'Production'  # Requires approval
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  displayName: 'Deploy to staging slot'
                - task: AzureAppServiceManage@0
                  displayName: 'Swap slots'
```

---

# 8. Quality Gates

## 8.1 CI Pipeline Quality Gates

- All builds must succeed
- All unit tests must pass
- All integration tests must pass
- No critical code analysis warnings
- Build artifacts must be generated

## 8.2 CD Pipeline Quality Gates

- All builds must succeed
- All unit tests must pass
- All integration tests must pass
- Manual approval required
- Staging slot validation must pass
- Post-swap health checks must pass

---

# 9. Pipeline Artifacts

## 9.1 CI Pipeline Artifacts

- Compiled binaries
- Test results
- Test coverage reports
- Build logs

## 9.2 CD Pipeline Artifacts

- Production-ready binaries
- Test results
- Deployment logs
- Health check results

---

# 10. Monitoring and Notifications

## 10.1 Pipeline Notifications

- Email notifications on pipeline completion
- Email notifications on pipeline failures
- Email notifications for approval requests

## 10.2 Pipeline Monitoring

- View pipeline runs in Azure DevOps
- Monitor build and test durations
- Track deployment success rates
- Review approval history

---

# 11. Troubleshooting

## 11.1 Common Issues

### CI Pipeline Not Triggering

**Issue**: CI pipeline doesn't trigger on `feature` branch push

**Solutions**:
- Verify branch name is exactly `feature`
- Check pipeline trigger configuration in `ci.yml`
- Verify Azure DevOps pipeline is connected to repository

### CD Pipeline Approval Not Working

**Issue**: Approval gates not appearing in deployment

**Solutions**:
- Verify Azure DevOps Environment is configured
- Check environment name matches pipeline YAML
- Verify approvers are assigned to environment
- Check environment approval settings

### Tests Failing in Pipeline

**Issue**: Tests pass locally but fail in pipeline

**Solutions**:
- Check test configuration matches local setup
- Verify test data dependencies are available
- Review test logs for specific failures
- Ensure test projects are included in solution

---

# 12. Best Practices

## 12.1 Pipeline Design

- Keep pipelines simple and focused
- Use separate pipelines for CI and CD
- Fail fast on errors
- Provide clear error messages

## 12.2 Testing Strategy

- Run all tests in CI pipeline
- Run all tests in CD pipeline before deployment
- Never skip tests in production pipeline
- Maintain high test coverage

## 12.3 Deployment Strategy

- Always use staging slots for production
- Validate staging before slot swap
- Implement automatic rollback
- Monitor post-deployment health

---
