# Student Course Enrollment System – Production Environment Setup

# 1. Overview

This guide provides step-by-step instructions for configuring the production environment for the Student Course Enrollment System. It covers Microsoft Entra ID app registration, configuration, deployment, and verification.

### Production Environment Characteristics

| Aspect | Configuration |
|--------|---------------|
| **Authentication** | Microsoft Entra ID |
| **Database** | In-memory (resets on restart) |
| **Deployment** | Manual approval required |
| **Configuration** | `appsettings.Production.json` |
| **Logging** | Warning level (reduced verbosity) |

---

# 2. Prerequisites

## 2.1 Azure Subscription

- Active Azure subscription
- Appropriate permissions to create Microsoft Entra ID app registrations
- Access to Azure Portal

## 2.2 Azure CLI

Install Azure CLI for command-line setup. See [Local Development Setup](4.0-local_development_setup.md#22-azure-cli-optional---for-azure-setup) for installation instructions.

## 2.3 Azure Resource Naming Conventions

Follow Microsoft's recommended naming conventions: `{prefix}-{application}-{environment}` (e.g., `app-studentcourseenrollment-prod`).

**Common prefixes:**
- App Service: `app-`
- Resource Group: `rg-`
- Key Vault: `kv-` (max 24 chars, lowercase alphanumeric)
- App Service Plan: `plan-` or `asp-`

See [Section 14](#14-azure-resource-naming-reference) for complete naming reference.

## 2.4 Required Information

Before starting, gather:
- Azure subscription ID
- Microsoft Entra ID tenant ID (or ability to create app registration)
- Production domain/URL for redirect URIs
- Production API URL
- Planned resource names following naming conventions

---

# 3. Understanding App Registration vs App Service

Before proceeding, it's important to understand the difference between these two Azure resources:

## 3.1 App Registration (Microsoft Entra ID)
- **Location**: Microsoft Entra ID (formerly Azure Active Directory)
- **Purpose**: Handles authentication and authorization
- **What it does**: 
  - Registers your application with Microsoft Entra ID
  - Manages redirect URIs (where users are sent after login)
  - Stores client ID, tenant ID, and client secrets
  - Configures which users/applications can authenticate
- **Where to find it**: Azure Portal → Microsoft Entra ID → App registrations

## 3.2 App Service (Azure)
- **Location**: Azure Portal → App Services
- **Purpose**: Hosts and runs your application
- **What it does**:
  - Provides the web server where your application runs
  - Gives you a URL like `https://app-studentcourseenrollment-prod.azurewebsites.net`
  - Handles deployment, scaling, and hosting
- **Where to find it**: Azure Portal → App Services

## 3.3 How They Work Together

1. **App Service** hosts your application and provides the URL where it runs
2. **App Registration** handles authentication and needs to know your App Service URL
3. The **redirect URI** in App Registration must match your App Service URL exactly
4. Your application (running on App Service) uses the App Registration credentials to authenticate users

## 3.4 Recommended Order of Operations

**Recommended Approach: Create App Service First**

This approach is recommended because:
- You'll know the exact App Service URL before creating the App Registration
- You can set the redirect URI correctly during App Registration creation
- No need to go back and update the redirect URI later

**Steps:**
1. ✅ Create App Service in Azure Portal (Section 4)
2. ✅ Note the App Service URL (e.g., `https://app-studentcourseenrollment-prod.azurewebsites.net`)
3. ✅ Create App Registration in Microsoft Entra ID (Section 5)
4. ✅ Add the App Service URL as the redirect URI during registration

**Alternative: Create App Registration First**
- If you prefer, you can create the App Registration first
- Leave the redirect URI empty during registration
- Add it later in the Authentication section once you have your App Service URL

---

# 4. Create Azure App Service

**Important**: Create the App Service first so you know the exact URL to use as the redirect URI in the App Registration.

## 4.1 Create App Service via Azure Portal

### Step 1: Navigate to App Services

1. Go to [Azure Portal](https://portal.azure.com)
2. Sign in with your Azure account
3. In the search bar at the top, type "App Services" and select it
4. Click **Create** or **+ Add** to create a new App Service

### Step 2: Configure Basic Settings

Fill in the **Basics** tab:

1. **Subscription**: Select your Azure subscription
2. **Resource Group**: 
   - Select existing or click **Create new**
   - Name: `rg-studentcourseenrollment-prod` (following naming convention)
3. **Name**: `app-studentcourseenrollment-prod`
   - This will create the URL: `https://app-studentcourseenrollment-prod.azurewebsites.net`
   - **Important**: Note this exact URL - you'll need it for the redirect URI
4. **Publish**: Select **Code** (for .NET application)
5. **Runtime stack**: Select **.NET** and choose the appropriate version (e.g., `.NET 8 (LTS)`)
6. **Operating System**: Select **Windows** or **Linux** (Windows recommended for .NET)
7. **Region**: Select the region closest to your users

### Step 3: Configure App Service Plan

1. Click **Create new** under App Service Plan
2. **Name**: `plan-studentcourseenrollment-prod`
3. **Operating System**: Match your App Service OS selection
4. **Region**: Match your App Service region
5. **Pricing tier**: 
   - For production, select an appropriate tier (e.g., **Basic B1** minimum, **Standard S1** recommended)
   - Review pricing and select based on your needs

### Step 4: Review and Create

1. Review all settings
2. Click **Review + create**
3. After validation passes, click **Create**
4. Wait for deployment to complete (usually 2-5 minutes)

### Step 5: Note Your App Service URL

Once deployment is complete:

1. Click **Go to resource** or navigate to your App Service
2. In the **Overview** page, note the **URL**:
   - Example: `https://app-studentcourseenrollment-prod.azurewebsites.net`
3. **Save this URL** - you'll need it for:
   - The redirect URI in App Registration: `{URL}/signin-oidc`
   - Example: `https://app-studentcourseenrollment-prod.azurewebsites.net/signin-oidc`

### Step 6: Configure Application Settings (Optional - Can be done later)

You can configure these now or after creating the App Registration:

1. In your App Service, go to **Configuration** → **Application settings**
2. You'll add these settings later after creating the App Registration:
   - `Authentication:Schemes:EntraId:TenantId`
   - `Authentication:Schemes:EntraId:ClientId`
   - `Authentication:Schemes:EntraId:ClientSecret`
   - `Jwt:Issuer`
   - `Jwt:Audience`

**Note**: The App Service is now created. You can deploy your application to it later. For now, proceed to create the App Registration with the redirect URI pointing to this App Service.

---

# 5. Microsoft Entra ID App Registration

Now that you have created your App Service and know its URL, create the App Registration with the correct redirect URI.

## 5.1 Create App Registration via Azure Portal

### Step 1: Navigate to Azure Portal

1. Go to [Azure Portal](https://portal.azure.com)
2. Sign in with your Azure account
3. Navigate to **Microsoft Entra ID** (formerly Azure Active Directory)

### Step 2: Create App Registration

1. In Microsoft Entra ID, go to **App registrations**
2. Click **New registration**
3. Fill in the registration form:
   - **Name**: `app-studentcourseenrollment-prod`
   - **Supported account types**: 
     - Select appropriate option (e.g., "Accounts in this organizational directory only" for single tenant)
   - **Redirect URI** (this is where you configure where Azure AD redirects after authentication):
     - Platform: Select **Web** from the dropdown
     - URI: Enter your App Service URL from Section 4, Step 5, plus `/signin-oidc`
       - Example: `https://app-studentcourseenrollment-prod.azurewebsites.net/signin-oidc`
       - **Important**: Use the exact URL from your App Service (created in Section 4)
       - The path `/signin-oidc` is the standard OIDC callback path
4. Click **Register**

**Note**: Since you created the App Service first (Section 4), you already know the exact URL to use here.

### Step 3: Note App Registration Details

After registration, note these values from the **Overview** page:

- **Application (client) ID** - This is your `ClientId`
- **Directory (tenant) ID** - This is your `TenantId`

Save these values for configuration.

### Step 4: Create Client Secret

1. In the Microsoft Entra ID app registration, go to **Certificates & secrets**
2. Click **New client secret**
3. Fill in:
   - **Description**: `Production Client Secret`
   - **Expires**: Select appropriate expiration (e.g., 12 months, 24 months)
4. Click **Add**
5. Copy the secret value immediately - it will not be shown again
   - **Important**: Save this value now - you'll need it for the next step
   - The secret value will not be displayed again after you leave this page

### Step 5: Store Client Secret in Azure Key Vault

Store the client secret securely in Azure Key Vault. See [Section 6.3](#63-configure-app-service-to-use-azure-key-vault) for complete Key Vault setup and App Service configuration instructions.

### Step 6: Configure API Permissions

If you need to call Microsoft Graph API or other Microsoft services:

1. Go to **API permissions**
2. Click **Add a permission**
3. Select **Microsoft Graph** or the API you need
4. Choose **Delegated permissions** or **Application permissions**
5. Select the permissions you need (e.g., `User.Read`)
6. Click **Add permissions**
7. If required, click **Grant admin consent** (requires admin privileges)

### Step 7: Configure Additional Redirect URIs

**Important Note**: Redirect URIs are configured in **Microsoft Entra ID App Registration**, NOT in Azure App Service. The App Service is where your application runs, but authentication redirects are configured in the App Registration.

To add or modify redirect URIs:

1. In Azure Portal, navigate to **Microsoft Entra ID** (formerly Azure Active Directory)
2. Click on **App registrations** in the left menu
3. Find and click on your app registration (e.g., `app-studentcourseenrollment-prod`)
4. In the left menu of the app registration, click on **Authentication**
5. Scroll down to the **Redirect URIs** section
6. Click **Add URI** to add a new redirect URI, or click on an existing URI to edit it
7. Select the platform type (usually **Web**)
8. Enter the redirect URI:
   - For Azure App Service: `https://app-studentcourseenrollment-prod.azurewebsites.net/signin-oidc`
   - For custom domain: `https://your-custom-domain.com/signin-oidc`
   - For localhost (development): `https://localhost:5001/signin-oidc` (only for testing)
9. Click **Save** at the top of the page

**Common Redirect URIs to Add:**
- Production App Service: `https://app-studentcourseenrollment-prod.azurewebsites.net/signin-oidc`
- Custom domain (if configured): `https://your-custom-domain.com/signin-oidc`
- Frontend URL (if separate): `https://your-frontend-url.com/signin-oidc`

**Note**: The redirect URI must exactly match the URL where your application is hosted, including the protocol (https), domain, and path (`/signin-oidc`).

---

## 5.2 Create App Registration via Azure CLI

### Step 1: Login to Azure

```bash
az login
```

This will open a browser window for authentication.

### Step 2: Set Active Subscription

```bash
# List subscriptions
az account list --output table

# Set active subscription
az account set --subscription "<subscription-id-or-name>"
```

### Step 3: Create App Registration

```bash
# Create app registration
az ad app create \
  --display-name "app-studentcourseenrollment-prod" \
  --web-redirect-uris "https://app-studentcourseenrollment-prod.azurewebsites.net/signin-oidc" \
  --enable-id-token-issuance true
```

### Step 4: Get App Registration Details

```bash
# Get app registration by display name
az ad app list --display-name "app-studentcourseenrollment-prod" --query "[].{AppId:appId, DisplayName:displayName}" --output table

# Get tenant ID
az account show --query tenantId --output tsv
```

### Step 5: Create Client Secret

```bash
# Get the app ID from previous step
APP_ID="<your-app-id>"

# Create client secret (valid for 12 months)
az ad app credential reset --id $APP_ID --years 1
```

Save the `password` value from the output as your client secret.

### Step 6: Store Secrets in Azure Key Vault

Store secrets in Key Vault. See [Section 6.3](#63-configure-app-service-to-use-azure-key-vault) for complete setup instructions.

---

# 6. Configure Production Settings

## 6.1 Update appsettings.Production.json

**Important**: For production, you should NOT store actual secrets (especially the Client Secret) in `appsettings.Production.json`. This file is committed to source control and should only contain non-sensitive configuration or placeholders. Real secrets must come from Azure Key Vault via App Service configuration.

### Option 1: Minimal Configuration (Recommended for Production)

Create or update `src/StudentCourseEnrollment.Api/appsettings.Production.json` with minimal configuration. Secrets will be provided via App Service settings (which reference Key Vault):

```json
{
  "Authentication": {
    "Schemes": {
      "EntraId": {
        "Instance": "https://login.microsoftonline.com/",
        "CallbackPath": "/signin-oidc"
      }
    }
  },
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Error"
    }
  }
}
```

**Note**: 
- TenantId, ClientId, and ClientSecret are NOT in this file
- These values will be provided via App Service Application Settings (configured in Section 6.3)
- App Service settings override values in appsettings files

### Option 2: Template with Placeholders (For Reference Only)

If you want to document the expected structure, you can include placeholders (but never commit actual values):

```json
{
  "Authentication": {
    "Schemes": {
      "EntraId": {
        "Instance": "https://login.microsoftonline.com/",
        "TenantId": "<configured-via-app-service>",
        "ClientId": "<configured-via-app-service>",
        "ClientSecret": "<configured-via-key-vault>",
        "CallbackPath": "/signin-oidc"
      }
    }
  },
  "Jwt": {
    "Issuer": "<configured-via-app-service>",
    "Audience": "<configured-via-app-service>"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Error"
    }
  }
}
```

**Critical Security Rules**:
- ❌ **NEVER** put actual Client Secret values in `appsettings.Production.json`
- ❌ **NEVER** commit secrets to source control
- ✅ **ALWAYS** store Client Secret in Azure Key Vault
- ✅ **ALWAYS** use App Service Application Settings with Key Vault references for production
- ✅ Tenant ID and Client ID can be in App Service settings (not sensitive, but Key Vault is recommended)

**Next Steps**: After creating this file, proceed to Section 6.3 to configure App Service to read secrets from Azure Key Vault.

## 6.2 Configuration Structure

### Authentication Configuration

- **Instance**: Always `https://login.microsoftonline.com/` for public Microsoft Entra ID
- **TenantId**: Your Microsoft Entra ID tenant ID
- **ClientId**: Your app registration client ID
- **ClientSecret**: The client secret value (store securely)
- **CallbackPath**: OIDC callback path `/signin-oidc`

### JWT Configuration

- **Issuer**: Entra ID token issuer URL `https://login.microsoftonline.com/{tenant-id}/v2.0`
- **Audience**: App registration client ID, must match the token audience

### Logging Configuration

Production uses reduced logging:
- **Default**: Warning
- **Microsoft.AspNetCore**: Warning
- **Microsoft.EntityFrameworkCore**: Error

## 6.3 Configure App Service to Use Azure Key Vault

Use Azure Key Vault for secure secret management. **Client Secret** (REQUIRED) must be in Key Vault. Tenant ID and Client ID can be in Key Vault (recommended) or App Service settings.

### 6.3.1: Create Key Vault and Store Secrets

**Via Azure Portal:**

1. Create Key Vault: Azure Portal → Key Vaults → Create
   - Name: `kv-sce-prod` (max 24 chars, lowercase alphanumeric)
   - Resource Group: `rg-studentcourseenrollment-prod`
   - Region: Same as App Service
   - Pricing tier: Standard

2. Store secrets in Key Vault → Secrets:
   - `EntraId-ClientSecret` (REQUIRED)
   - `EntraId-TenantId` (recommended)
   - `EntraId-ClientId` (recommended)
   - `Jwt--Issuer` (optional: `https://login.microsoftonline.com/{tenant-id}/v2.0`)
   - `Jwt--Audience` (optional: same as Client ID)

**Note**: Use double dashes (`--`) in secret names to represent colons (`:`) in configuration paths.

**Via Azure CLI:**

```bash
KEY_VAULT_NAME="kv-sce-prod"
RESOURCE_GROUP="rg-studentcourseenrollment-prod"
CLIENT_SECRET="<your-client-secret>"
TENANT_ID="<your-tenant-id>"
CLIENT_ID="<your-client-id>"

# Create Key Vault
az keyvault create --name $KEY_VAULT_NAME --resource-group $RESOURCE_GROUP --location eastus --sku Standard

# Store secrets
az keyvault secret set --vault-name $KEY_VAULT_NAME --name "EntraId-ClientSecret" --value "$CLIENT_SECRET"
az keyvault secret set --vault-name $KEY_VAULT_NAME --name "EntraId-TenantId" --value "$TENANT_ID"
az keyvault secret set --vault-name $KEY_VAULT_NAME --name "EntraId-ClientId" --value "$CLIENT_ID"
az keyvault secret set --vault-name $KEY_VAULT_NAME --name "Jwt--Issuer" --value "https://login.microsoftonline.com/$TENANT_ID/v2.0"
az keyvault secret set --vault-name $KEY_VAULT_NAME --name "Jwt--Audience" --value "$CLIENT_ID"
```

### 6.3.2: Enable Managed Identity for App Service

1. In Azure Portal, navigate to your App Service: `app-studentcourseenrollment-prod`
2. Go to **Identity** in the left menu
3. Under **System assigned** tab, toggle **Status** to **On**
4. Click **Save**
5. Wait for the identity to be created (usually 10-30 seconds)
6. Note the **Object (principal) ID** - you'll need this for Key Vault access

### 6.3.3: Grant App Service Access to Key Vault

**For RBAC-enabled Key Vaults:**
1. Key Vault → Access control (IAM) → Add role assignment
2. Role: **Key Vault Secrets User**
3. Assign to: Managed identity → App Service → Select your App Service
4. Review and assign

**For Access Policy-enabled Key Vaults (Legacy):**
1. Key Vault → Access policies → Add Access Policy
2. Secret permissions: **Get** (required), **List** (optional)
3. Select principal: Your App Service (use Object ID from step 6.3.2)
4. Save

**Via Azure CLI (RBAC):**
```bash
PRINCIPAL_ID=$(az webapp identity show --name $APP_SERVICE_NAME --resource-group $RESOURCE_GROUP --query principalId -o tsv)
az role assignment create --role "Key Vault Secrets User" --assignee $PRINCIPAL_ID \
  --scope "/subscriptions/$(az account show --query id -o tsv)/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.KeyVault/vaults/$KEY_VAULT_NAME"
```

**Via Azure CLI (Access Policies):**
```bash
az keyvault set-policy --name $KEY_VAULT_NAME --object-id $PRINCIPAL_ID --secret-permissions get list
```

### 6.3.4: Configure App Service Application Settings

**App Service → Configuration → Application settings → Add:**

| Setting Name | Value |
|--------------|-------|
| `Authentication:Schemes:EntraId:Instance` | `https://login.microsoftonline.com/` |
| `Authentication:Schemes:EntraId:TenantId` | `@Microsoft.KeyVault(SecretUri=https://kv-sce-prod.vault.azure.net/secrets/EntraId-TenantId/)` or direct value |
| `Authentication:Schemes:EntraId:ClientId` | `@Microsoft.KeyVault(SecretUri=https://kv-sce-prod.vault.azure.net/secrets/EntraId-ClientId/)` or direct value |
| `Authentication:Schemes:EntraId:ClientSecret` | `@Microsoft.KeyVault(SecretUri=https://kv-sce-prod.vault.azure.net/secrets/EntraId-ClientSecret/)` |
| `Jwt:Issuer` | `@Microsoft.KeyVault(SecretUri=https://kv-sce-prod.vault.azure.net/secrets/Jwt--Issuer/)` or `https://login.microsoftonline.com/{tenant-id}/v2.0` |
| `Jwt:Audience` | `@Microsoft.KeyVault(SecretUri=https://kv-sce-prod.vault.azure.net/secrets/Jwt--Audience/)` or Client ID |

**Note**: Replace `kv-sce-prod` with your Key Vault name. Secret URI format: `https://{key-vault-name}.vault.azure.net/secrets/{secret-name}/`

**Via Azure CLI:**
```bash
az webapp config appsettings set --name $APP_SERVICE_NAME --resource-group $RESOURCE_GROUP --settings \
  "Authentication:Schemes:EntraId:Instance=https://login.microsoftonline.com/" \
  "Authentication:Schemes:EntraId:TenantId=@Microsoft.KeyVault(SecretUri=https://$KEY_VAULT_NAME.vault.azure.net/secrets/EntraId-TenantId/)" \
  "Authentication:Schemes:EntraId:ClientId=@Microsoft.KeyVault(SecretUri=https://$KEY_VAULT_NAME.vault.azure.net/secrets/EntraId-ClientId/)" \
  "Authentication:Schemes:EntraId:ClientSecret=@Microsoft.KeyVault(SecretUri=https://$KEY_VAULT_NAME.vault.azure.net/secrets/EntraId-ClientSecret/)" \
  "Jwt:Issuer=@Microsoft.KeyVault(SecretUri=https://$KEY_VAULT_NAME.vault.azure.net/secrets/Jwt--Issuer/)" \
  "Jwt:Audience=@Microsoft.KeyVault(SecretUri=https://$KEY_VAULT_NAME.vault.azure.net/secrets/Jwt--Audience/)"
```

**Verify**: After saving, check that Key Vault references show no errors. If errors occur, verify Key Vault name, secret names (case-sensitive), Managed Identity permissions, and wait 1-2 minutes for identity propagation.

### Benefits of Using Key Vault References

- **Automatic Updates**: When secrets are updated in Key Vault, App Service automatically retrieves the new values (may require restart)
- **No Secret Exposure**: Secrets never appear in App Service configuration UI or logs
- **Centralized Management**: All secrets managed in one place
- **Audit Trail**: Key Vault provides detailed access logs
- **Rotation Support**: Easy to rotate secrets without code changes

---

# 7. Verify Microsoft Entra ID Authentication

## 7.1 Code Verification

The application automatically configures Microsoft Entra ID authentication when:

1. Environment is **not** Development (`!IsDevelopment()`)
2. `Authentication:Schemes:EntraId:Instance` is configured
3. `Authentication:Schemes:EntraId:TenantId` is configured

The authentication logic in `Program.cs`:

```csharp
if (builder.Environment.IsDevelopment())
{
    ConfigureSymmetricKeyValidation();
}
else
{
    var entraIdInstance = builder.Configuration["Authentication:Schemes:EntraId:Instance"];
    var entraIdTenantId = builder.Configuration["Authentication:Schemes:EntraId:TenantId"];

    if (!string.IsNullOrEmpty(entraIdInstance) && !string.IsNullOrEmpty(entraIdTenantId))
    {
        var entraIdAuthority = $"{entraIdInstance.TrimEnd('/')}/{entraIdTenantId}/v2.0";
        ConfigureExternalAuthority(entraIdAuthority, true);
    }
    else
    {
        ConfigureSymmetricKeyValidation();
    }
}
```

## 7.2 Authentication Flow

1. User attempts to access protected endpoint
2. If not authenticated, redirected to Microsoft Entra ID login
3. User authenticates with Microsoft Entra ID credentials
4. Microsoft Entra ID issues JWT token with claims
5. Application validates token using Microsoft Entra ID's public keys
6. User is authenticated and can access protected resources

## 7.3 Token Validation

The application validates tokens by:
- **Issuer**: Must match Microsoft Entra ID authority
- **Audience**: Must match configured client ID
- **Lifetime**: Token must not be expired
- **Signing Key**: Validated using Microsoft Entra ID's public keys, fetched automatically

---

# 8. Database Configuration

## 8.1 In-Memory Database

Production uses **Entity Framework Core In-Memory Database**:

- **No connection string required** - Database is created in memory
- **Data resets on restart** - All data is lost when application stops
- **No external database needed** - No SQL Server, PostgreSQL, or other database installation required

### Database Initialization

The database is automatically initialized when the application starts via `InitializeDbAsync()` in `Program.cs`.

For production workloads requiring data persistence, consider migrating to a persistent database such as SQL Server or PostgreSQL.

---

# 9. Deployment

## 9.1 Pre-Deployment Checklist

- [ ] Microsoft Entra ID app registration created
- [ ] Client ID, Tenant ID, and Client Secret obtained
- [ ] `appsettings.Production.json` configured (or secrets stored securely)
- [ ] Redirect URIs configured in Azure AD
- [ ] CORS configured for production frontend URL
- [ ] HTTPS certificates configured
- [ ] Logging configuration verified
- [ ] All tests passing
- [ ] Code reviewed and approved
- [ ] CI pipeline has passed on `feature` branch
- [ ] Code merged to `main` branch
- [ ] Azure DevOps Environment configured with approval gates

## 9.2 Deployment Pipeline

Production deployments use the **CD Pipeline** (`devops/pipelines/prod-deploy.yml`) which is manually triggered from the `main` branch.

### 9.2.1 Pipeline Workflow

1. **Trigger**: Manual trigger from `main` branch
2. **Build Stage**: Builds solution in Release configuration
3. **Test Stage**: Runs all unit and integration tests
4. **Deploy Stage**: 
   - Deploys to Azure App Service staging slot
   - Runs smoke tests
   - **Requires manual approval** before slot swap
   - Performs slot swap (zero-downtime)
   - Runs post-deployment health checks

### 9.2.2 Approval Gates Configuration

Before deploying, configure approval gates in Azure DevOps:

1. Navigate to **Pipelines** → **Environments** in Azure DevOps
2. Create or select **Production** environment
3. Click **Approvals and checks**
4. Add **Approvals**:
   - Add **Tech Lead** as required approver
   - Optionally add **Security Lead** as approver
   - Configure timeout (e.g., 24 hours)
5. Save configuration

### 9.2.3 Deployment Steps

1. **Merge to Main Branch**
   - Ensure all work is merged to `main` via Pull Request
   - Verify CI pipeline passed on `feature` branch

2. **Trigger CD Pipeline**
   - Navigate to Azure DevOps Pipelines
   - Select `prod-deploy.yml` pipeline
   - Click **Run pipeline**
   - Select `main` branch
   - Click **Run**

3. **Monitor Pipeline Execution**
   - Build stage completes
   - Test stage completes (all tests must pass)
   - Deploy stage waits for approval

4. **Approve Deployment**
   - Approvers receive email notification
   - Approve deployment in Azure DevOps
   - Deployment proceeds to staging slot

5. **Slot Swap**
   - Pipeline validates staging slot
   - Performs slot swap automatically
   - Runs post-swap health checks

6. **Verify Deployment**
   - Check application logs
   - Verify health endpoints
   - Test authentication flow
   - Verify API endpoints are accessible

### 9.2.4 Manual Deployment (Alternative)

If pipeline deployment is not available, manual deployment steps:

1. **Build Application**
   ```bash
   dotnet build --configuration Release
   ```

2. **Run Tests**
   ```bash
   dotnet test
   ```

3. **Package Application**
   - Package for deployment to Azure App Service

4. **Configure Environment Variables**
   - Set `Authentication:Schemes:EntraId:TenantId`
   - Set `Authentication:Schemes:EntraId:ClientId`
   - Set `Authentication:Schemes:EntraId:ClientSecret`
   - Set `Jwt:Issuer`
   - Set `Jwt:Audience`

5. **Deploy to Production**
   - Deploy to Azure App Service staging slot
   - Validate staging deployment
   - Perform slot swap
   - Verify production deployment

---

# 10. Post-Deployment Verification

## 10.1 Health Checks

1. **Application Health**
   - Navigate to health endpoint
   - Verify application is running

2. **Database Initialization**
   - Check logs for database initialization
   - Verify no errors during startup

3. **Authentication Flow**
   - Attempt to access protected endpoint
   - Verify redirect to Microsoft Entra ID login
   - Complete login and verify token is issued
   - Verify access to protected resources

## 10.2 API Verification

1. **Public Endpoints**
   - Test `GET /courses` without authentication
   - Verify CORS headers are correct

2. **Protected Endpoints**
   - Test `GET /enrollments/me` with authentication
   - Test `POST /enrollments` with Student role
   - Test `POST /courses` with Admin role

3. **Token Validation**
   - Verify tokens are validated correctly
   - Verify role claims are extracted
   - Verify authorization policies are enforced

---

# 11. Troubleshooting

## 11.1 Authentication Issues

### Issue: "Invalid token" or "Token validation failed"

**Possible Causes:**
- Incorrect Tenant ID or Client ID
- Token audience mismatch
- Token expired
- Clock skew between servers

**Solutions:**
- Verify `appsettings.Production.json` contains correct Tenant ID and Client ID
- Verify JWT Audience matches Client ID
- Check token expiration time
- Ensure server clocks are synchronized

### Issue: "Redirect URI mismatch"

**Possible Causes:**
- Redirect URI in app registration doesn't match application callback path
- HTTPS vs HTTP mismatch

**Solutions:**
- Verify redirect URI in Microsoft Entra ID app registration matches `CallbackPath` in configuration
- Ensure production environment uses HTTPS
- Add all required redirect URIs to app registration

### Issue: "Client secret invalid"

**Possible Causes:**
- Client secret expired
- Incorrect secret value
- Secret not properly configured

**Solutions:**
- Check client secret expiration in Microsoft Entra ID
- Verify secret value is correct with no extra spaces and proper encoding
- Create new client secret if expired

## 11.2 Configuration Issues

### Issue: "Microsoft Entra ID not configured, falling back to JWT Bearer"

**Possible Causes:**
- `Authentication:Schemes:EntraId:Instance` not set
- `Authentication:Schemes:EntraId:TenantId` not set
- Configuration not loaded

**Solutions:**
- Verify `appsettings.Production.json` exists and is loaded
- Check configuration values are set correctly
- Verify environment is set to Production with `ASPNETCORE_ENVIRONMENT=Production`

## 11.3 Logging Issues

### Issue: Too many logs or not enough logs

**Solutions:**
- Adjust log levels in `appsettings.Production.json`
- Use structured logging for better filtering
- Configure log aggregation with Application Insights

---

# 12. Security Best Practices

## 12.1 Secrets Management

- Never commit secrets to source control
- Use Azure Key Vault for production secrets following naming convention `kv-{application}-{environment}`
- Use environment variables for sensitive configuration
- Rotate client secrets regularly
- Use managed identities when possible for Azure resources

## 12.2 Token Security

- Tokens are validated using Microsoft Entra ID's public keys
- Token lifetime is validated with default expiration of 1 hour
- Audience validation ensures tokens are for your application
- HTTPS is required for all production communication

## 12.3 Configuration Security

- Use **least privilege** for app registration permissions
- Regularly review and audit app registration permissions
- Monitor authentication failures
- Set up alerts for suspicious activity

---

# 13. Monitoring and Maintenance

## 13.1 Monitoring

- Monitor authentication success and failure rates
- Track token validation errors
- Monitor application performance using Application Insights
- Set up alerts for authentication issues
- Use Log Analytics Workspace for centralized logging

## 13.2 Maintenance Tasks

- Rotate client secrets before expiration
- Regularly review app registration permissions
- Review logs for authentication patterns and issues
- Keep dependencies updated

---

# 14. Azure Resource Naming Reference

## 14.1 Complete Naming Convention Table

| Resource Type | Prefix | Max Length | Allowed Characters | Example |
|---------------|--------|------------|-------------------|---------|
| App Service | `app-` | 60 | Alphanumeric, hyphens | `app-studentcourseenrollment-prod` |
| Resource Group | `rg-` | 90 | Alphanumeric, hyphens, underscores, periods, parentheses | `rg-studentcourseenrollment-prod` |
| Key Vault | `kv-` | 24 | Alphanumeric, hyphens | `kv-studentcourseenrollment-prod` |
| Storage Account | `st` | 24 | Lowercase alphanumeric only | `ststudentcourseenrollmentprod` |
| App Service Plan | `plan-` or `asp-` | 40 | Alphanumeric, hyphens | `plan-studentcourseenrollment-prod` |
| Application Insights | `appi-` | 260 | Alphanumeric, hyphens, underscores | `appi-studentcourseenrollment-prod` |
| Log Analytics Workspace | `law-` | 63 | Alphanumeric, hyphens, underscores | `law-studentcourseenrollment-prod` |
| Function App | `func-` | 60 | Alphanumeric, hyphens | `func-studentcourseenrollment-prod` |
| SQL Server | `sql-` | 63 | Alphanumeric, hyphens | `sql-studentcourseenrollment-prod` |
| SQL Database | `sqldb-` | 128 | Alphanumeric, hyphens, underscores | `sqldb-studentcourseenrollment-prod` |
| Virtual Network | `vnet-` | 64 | Alphanumeric, hyphens, underscores, periods | `vnet-studentcourseenrollment-prod` |
| Public IP | `pip-` | 80 | Alphanumeric, hyphens, underscores, periods | `pip-studentcourseenrollment-prod` |
| Network Security Group | `nsg-` | 80 | Alphanumeric, hyphens, underscores, periods | `nsg-studentcourseenrollment-prod` |
| Container Registry | `acr-` | 50 | Alphanumeric, hyphens | `acr-studentcourseenrollment-prod` |

## 14.2 Naming Best Practices

1. **Consistency**: Use the same naming pattern across all resources
2. **Environment Suffix**: Always include environment (`-prod`, `-dev`, `-stg`)
3. **Length**: Keep names concise but descriptive
4. **Lowercase**: Use lowercase for all resource names
5. **Hyphens**: Use hyphens to separate words (except storage accounts)
6. **No Special Characters**: Avoid special characters except hyphens and underscores where allowed

## 14.3 Example Resource Group Structure

```
Resource Group: rg-studentcourseenrollment-prod
├── App Service: app-studentcourseenrollment-prod
├── App Service Plan: plan-studentcourseenrollment-prod
├── Key Vault: kv-studentcourseenrollment-prod
├── Application Insights: appi-studentcourseenrollment-prod
└── Log Analytics Workspace: law-studentcourseenrollment-prod
```

---

# 15. Additional Resources

- [Microsoft Azure Naming Conventions](https://learn.microsoft.com/en-us/azure/cloud-adoption-framework/ready/azure-best-practices/naming-and-tagging)
- [Entra ID App Registration Documentation](https://learn.microsoft.com/en-us/entra/identity-platform/quickstart-register-app)
- [Entra ID Authentication](https://learn.microsoft.com/en-us/entra/identity-platform/)
- [JWT Token Validation](https://learn.microsoft.com/en-us/entra/identity-platform/access-tokens)
- [ASP.NET Core Authentication](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/)
- [Azure Key Vault](https://learn.microsoft.com/en-us/azure/key-vault/)
- [Azure App Service](https://learn.microsoft.com/en-us/azure/app-service/)

---

