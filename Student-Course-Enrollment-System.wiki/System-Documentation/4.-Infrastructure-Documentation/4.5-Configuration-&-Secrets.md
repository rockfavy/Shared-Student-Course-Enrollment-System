# Student Course Enrollment System – Configuration & Secrets
---

# 1. Overview

Configuration and secrets management for the Student Course Enrollment System. The system uses a layered configuration model that supports environment-specific settings and environment variable overrides.

---

# 2. Configuration Hierarchy

Configuration is loaded in the following order (later sources override earlier ones):

1. **`appsettings.json`** - Base defaults
2. **`appsettings.{Environment}.json`** - Environment-specific overrides
3. **Environment Variables** - Runtime overrides
4. **Azure App Service Configuration** - Cloud deployment overrides (Production)
5. **Azure Key Vault** - Secret values (Production)

**Important**: Environment variables and Azure App Service settings override file-based configuration.

---

# 3. Configuration Files

## 3.1 Base Configuration Template

**File**: `appsettings.json`

This file contains default configuration values that apply to all environments. It should contain only non-sensitive, common settings.

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}
```

## 3.2 Environment-Specific Configuration

### Development Environment

**File**: `appsettings.Development.json`

```json
{
  "Jwt": {
    "Issuer": "StudentCourseEnrollment",
    "Audience": "StudentCourseEnrollment",
    "SecretKey": "DevelopmentSecretKey-ChangeInProduction-Minimum32Characters"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Warning"
    }
  }
}
```

### Production Environment

**File**: `appsettings.Production.json`

```json
{
  "Authentication": {
    "Schemes": {
      "EntraId": {
        "Instance": "https://login.microsoftonline.com/",
        "TenantId": "{tenant-id}",
        "ClientId": "{client-id}",
        "ClientSecret": "{client-secret}",
        "CallbackPath": "/signin-oidc"
      }
    }
  },
  "Jwt": {
    "Issuer": "https://login.microsoftonline.com/{tenant-id}/v2.0",
    "Audience": "{client-id}"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Warning",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.EntityFrameworkCore": "Error"
    }
  }
}
```

---

# 4. Environment Variable Support

## 4.1 Overview

The application supports environment variables for configuration overrides. Environment variables take precedence over file-based configuration, allowing runtime configuration without code changes.

## 4.2 Naming Conventions

Environment variables use **double underscore (`__`)** to represent nested configuration keys:

| Configuration Path | Environment Variable |
|-------------------|---------------------|
| `Jwt:SecretKey` | `Jwt__SecretKey` |
| `Jwt:Issuer` | `Jwt__Issuer` |
| `Jwt:Audience` | `Jwt__Audience` |
| `Authentication:Schemes:EntraId:TenantId` | `Authentication__Schemes__EntraId__TenantId` |
| `Authentication:Schemes:EntraId:ClientId` | `Authentication__Schemes__EntraId__ClientId` |
| `Authentication:Schemes:EntraId:ClientSecret` | `Authentication__Schemes__EntraId__ClientSecret` |
| `Logging:LogLevel:Default` | `Logging__LogLevel__Default` |

## 4.3 Setting Environment Variables

### Windows (PowerShell)

```powershell
$env:Jwt__SecretKey = "YourSecretKeyHere"
$env:Jwt__Issuer = "StudentCourseEnrollment"
$env:Jwt__Audience = "StudentCourseEnrollment"
```

### Windows (Command Prompt)

```cmd
set Jwt__SecretKey=YourSecretKeyHere
set Jwt__Issuer=StudentCourseEnrollment
set Jwt__Audience=StudentCourseEnrollment
```

### Linux/macOS (Bash)

```bash
export Jwt__SecretKey="YourSecretKeyHere"
export Jwt__Issuer="StudentCourseEnrollment"
export Jwt__Audience="StudentCourseEnrollment"
```

### Azure App Service

1. Navigate to **App Service** → **Configuration** → **Application settings**
2. Add new application setting:
   - **Name**: `Jwt__SecretKey`
   - **Value**: `YourSecretKeyHere`
3. Click **Save**

### Azure App Service (Azure CLI)

```bash
az webapp config appsettings set \
  --resource-group rg-studentcourseenrollment-prod \
  --name app-studentcourseenrollment-prod \
  --settings Jwt__SecretKey="YourSecretKeyHere" \
             Jwt__Issuer="StudentCourseEnrollment" \
             Jwt__Audience="StudentCourseEnrollment"
```

## 4.4 Environment Variable Examples

### Override JWT Configuration

```bash
# Development
export Jwt__SecretKey="DevelopmentSecretKey-ChangeInProduction-Minimum32Characters"
export Jwt__Issuer="StudentCourseEnrollment"
export Jwt__Audience="StudentCourseEnrollment"

# Production
export Authentication__Schemes__EntraId__TenantId="your-tenant-id"
export Authentication__Schemes__EntraId__ClientId="your-client-id"
export Authentication__Schemes__EntraId__ClientSecret="your-client-secret"
export Jwt__Issuer="https://login.microsoftonline.com/your-tenant-id/v2.0"
export Jwt__Audience="your-client-id"
```

### Override Logging Configuration

```bash
export Logging__LogLevel__Default="Warning"
export Logging__LogLevel__Microsoft.AspNetCore="Warning"
export Logging__LogLevel__Microsoft.EntityFrameworkCore="Error"
```

## 4.5 Accessing Configuration in Code

The application uses ASP.NET Core's `IConfiguration` interface, which automatically reads from:
1. `appsettings.json`
2. `appsettings.{Environment}.json`
3. Environment variables
4. Command-line arguments

### Example Usage

```csharp
// In Program.cs or service classes
var secretKey = builder.Configuration["Jwt:SecretKey"];
var issuer = builder.Configuration["Jwt:Issuer"] ?? "StudentCourseEnrollment";
var audience = builder.Configuration["Jwt:Audience"] ?? "StudentCourseEnrollment";
```

Environment variables are automatically mapped to configuration keys using the double underscore convention.

---

# 5. Configuration Template Structure

## 5.1 Base Template (`appsettings.json`)

The base template should contain only:
- Non-sensitive default values
- Common logging configuration
- Application-wide settings

**Do NOT include**:
- Secrets or sensitive data
- Environment-specific values
- Connection strings with credentials

## 5.2 Environment-Specific Templates

Each environment has its own configuration file that overrides base settings:

- **Development**: `appsettings.Development.json` - Local development settings
- **Production**: `appsettings.Production.json` - Production settings (with placeholders)

## 5.3 Configuration Sections

### JWT Configuration

```json
{
  "Jwt": {
    "Issuer": "string",
    "Audience": "string",
    "SecretKey": "string (minimum 32 characters)"
  }
}
```

### Authentication Configuration

```json
{
  "Authentication": {
    "Schemes": {
      "EntraId": {
        "Instance": "https://login.microsoftonline.com/",
        "TenantId": "string",
        "ClientId": "string",
        "ClientSecret": "string",
        "CallbackPath": "/signin-oidc"
      }
    }
  }
}
```

### Logging Configuration

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information | Warning | Error",
      "Microsoft.AspNetCore": "Information | Warning | Error",
      "Microsoft.EntityFrameworkCore": "Information | Warning | Error"
    }
  }
}
```

---

# 6. Secrets Management

## 6.1 Local Development

- Store non-sensitive defaults in `appsettings.Development.json`
- Use placeholder values for sensitive data
- Never commit actual secrets to version control

## 6.2 Production

- Store secrets in **Azure Key Vault** (recommended)
- Use Azure App Service Application Settings with Key Vault references
- Never store secrets in `appsettings.Production.json` (use placeholders)

## 6.3 Secret Rotation

- Rotate secrets regularly
- Update Azure Key Vault secrets
- No code changes required when using Key Vault references

---

# 7. Configuration Best Practices

## 7.1 Security

- Never commit secrets to version control
- Use environment variables or Azure Key Vault for sensitive data
- Use placeholder values in configuration files
- Rotate secrets regularly

## 7.2 Organization

- Group related settings in configuration sections
- Use clear, descriptive names
- Document configuration options
- Keep base template minimal

## 7.3 Environment Isolation

- Each environment has its own configuration file
- Environment variables override file-based configuration
- Use different secrets for each environment
- Never share production secrets with development environments

---

# 8. Configuration Validation

## 8.1 Required Settings

The application requires the following configuration:

### Development
- `Jwt:SecretKey`
- `Jwt:Issuer`
- `Jwt:Audience`

### Production
- `Authentication:Schemes:EntraId:TenantId`
- `Authentication:Schemes:EntraId:ClientId`
- `Authentication:Schemes:EntraId:ClientSecret`
- `Jwt:Issuer`
- `Jwt:Audience`

## 8.2 Validation

The application validates configuration at startup:
- Missing required settings will cause startup failures
- Invalid JWT configuration will prevent authentication
- Invalid Entra ID configuration will prevent production authentication

---

# 9. Troubleshooting

## 9.1 Configuration Not Loading

**Issue**: Environment variables not being read

**Solutions**:
- Verify environment variable names use double underscore (`__`) for nested keys
- Check environment variable is set in the correct scope (user vs system)
- Restart the application after setting environment variables
- Verify configuration is accessed using `IConfiguration` interface

## 9.2 Configuration Override Not Working

**Issue**: Environment variable not overriding appsettings.json

**Solutions**:
- Verify environment variable name matches configuration path (use `__` for nested keys)
- Check environment variable is set before application starts
- Verify no typos in environment variable name
- Check configuration loading order (environment variables should override files)

## 9.3 Secret Exposure

**Issue**: Secrets visible in logs or configuration files

**Solutions**:
- Remove secrets from configuration files
- Use Azure Key Vault for production secrets
- Use environment variables for local development
- Review logging configuration to exclude sensitive data

---

# 10. Additional Resources

- [ASP.NET Core Configuration](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/)
- [Environment Variables in ASP.NET Core](https://learn.microsoft.com/en-us/aspnet/core/fundamentals/configuration/#environment-variables)
- [Azure Key Vault](https://learn.microsoft.com/en-us/azure/key-vault/)
- [Azure App Service Configuration](https://learn.microsoft.com/en-us/azure/app-service/configure-common)

---
